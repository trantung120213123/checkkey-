<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîë Roblox Key Manager X·ªãn</title>
    <style>
        :root { --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%); --card: white; --text: #333; --border: #ddd; --success: #56ab2f; --error: #721c24; }
        [data-theme="dark"] { --bg: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); --card: #2a2a3e; --text: #f0f0f0; --border: #444; --success: #4caf50; --error: #f44336; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 1rem; color: var(--text); transition: all 0.3s; }
        .container { background: var(--card); padding: 2.5rem; border-radius: 20px; box-shadow: 0 25px 50px rgba(0,0,0,0.15); max-width: 500px; width: 100%; text-align: center; animation: fadeIn 0.6s ease; position: relative; }
        .theme-toggle { position: absolute; top: 1rem; right: 1rem; background: none; border: 2px solid var(--border); color: var(--text); padding: 0.5rem; border-radius: 50%; cursor: pointer; font-size: 1.2rem; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        h1 { margin-bottom: 1rem; font-size: 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        button { width: 100%; padding: 14px; margin: 12px 0; border: none; border-radius: 10px; font-size: 1.1rem; cursor: pointer; transition: all 0.3s; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4); }
        .btn-success { background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%); color: white; }
        .btn-success:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(86, 171, 47, 0.4); }
        .btn-success:disabled { background: var(--border); cursor: not-allowed; }
        input { width: 100%; padding: 14px; margin: 12px 0; border: 2px solid var(--border); border-radius: 10px; font-size: 1.1rem; transition: all 0.3s; background: var(--card); color: var(--text); }
        input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 10px rgba(102, 126, 234, 0.3); }
        .key-display { background: linear-gradient(135deg, #d4edda 0%, #b8e6c9 100%); padding: 15px; border-radius: 10px; margin: 12px 0; font-family: 'Courier New', monospace; word-break: break-all; font-size: 1rem; color: #155724; border: 1px solid #c3e6cb; animation: slideIn 0.4s ease; position: relative; }
        .countdown { font-size: 0.9rem; color: #666; margin-top: 5px; font-weight: bold; }
        .copy-btn { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.2); color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }
        .result { padding: 15px; border-radius: 10px; margin: 12px 0; white-space: pre-wrap; font-size: 1rem; animation: fadeIn 0.4s ease; border: 1px solid; }
        .result.success { background: rgba(86, 171, 47, 0.1); color: var(--success); border-color: var(--success); }
        .result.error { background: rgba(244, 67, 54, 0.1); color: var(--error); border-color: var(--error); }
        .loading { display: none; text-align: center; margin: 12px 0; }
        .spinner { border: 4px solid var(--border); border-top: 4px solid #667eea; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .info { text-align: center; font-size: 0.9rem; color: #888; margin-top: 2rem; line-height: 1.5; }
        .export-btn { background: #6c757d; color: white; font-size: 0.9rem; width: auto; padding: 8px 16px; margin: 10px; }
        @media (max-width: 480px) { .container { padding: 1.5rem; } h1 { font-size: 1.6rem; } }
    </style>
</head>
<body>
    <div class="container">
        <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
        <h1>üîë Key Manager X·ªãn</h1>
        <p style="color: #888; margin-bottom: 1.5rem;">Roblox Premium | 24h Expire | 1 User/Key | Max 2/Key</p>
        
        <button class="btn-primary" onclick="getKey()">Generate Key</button>
        
        <div id="keyDisplay" class="key-display" style="display: none;">
            <div class="copy-btn" onclick="copyKey()">üìã Copy</div>
            <div id="keyText"></div>
            <div id="countdown" class="countdown"></div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>ƒêang x·ª≠ l√Ω...</p>
        </div>
        
        <input type="text" id="userId" placeholder="User ID Roblox (auto t·ª´ script)" maxlength="20" oninput="validateUserId(this)" />
        
        <button id="checkBtn" class="btn-success" onclick="checkKey()" disabled>Activate Key</button>
        <button class="export-btn" onclick="exportKeys()">Export Keys CSV</button>
        
        <div id="result" class="result" style="display: none;"></div>
        
        <div class="info">
            <strong>H∆∞·ªõng d·∫´n:</strong><br>
            1. Generate key & copy.<br>
            2. Paste v√†o Roblox script (UserId auto).<br>
            3. Check DB: Supabase > Tables.<br>
            <a href="#" onclick="fetchKeys(); return false;" style="color: #667eea;">View Keys</a> | <a href="#" onclick="cleanup(); return false;">Cleanup Expired</a>
        </div>
    </div>

    <script>
        let currentKey = '', expiresTime = null;

        function toggleTheme() {
            const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', theme);
            document.querySelector('.theme-toggle').textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        function validateUserId(input) {
            input.style.borderColor = /^\d+$/.test(input.value) ? '#56ab2f' : '#f44336';
        }

        async function apiCall(url, options) {
            document.getElementById('loading').style.display = 'block';
            try {
                const res = await fetch(url, options);
                if (!res.ok) throw new Error(`Error ${res.status}`);
                return await res.json();
            } catch (err) {
                throw new Error('M·∫°ng l·ªói: ' + err.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function showResult(text, type = 'success') {
            const el = document.getElementById('result');
            el.textContent = text;
            el.className = `result ${type}`;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 6000);
        }

        async function getKey() {
            try {
                const data = await apiCall('/api/getkey', { method: 'POST' });
                currentKey = data.key;
                expiresTime = new Date(data.expires_at).getTime();
                document.getElementById('keyText').innerHTML = data.key;
                document.getElementById('keyDisplay').style.display = 'block';
                document.getElementById('checkBtn').disabled = false;
                updateCountdown();
                setInterval(updateCountdown, 1000);
                showResult(`‚úÖ Key m·ªõi! H·∫øt h·∫°n: ${new Date(data.expires_at).toLocaleString()}`, 'success');
            } catch (err) {
                showResult('‚ùå ' + err.message, 'error');
            }
        }

        function updateCountdown() {
            if (!expiresTime) return;
            const now = Date.now();
            const distance = expiresTime - now;
            if (distance < 0) {
                document.getElementById('countdown').innerHTML = '‚è∞ ƒê√£ h·∫øt h·∫°n!';
                return;
            }
            const hours = Math.floor(distance / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            document.getElementById('countdown').innerHTML = `‚è≥ C√≤n: ${hours}h ${minutes}m ${seconds}s`;
        }

        async function checkKey() {
            const userId = document.getElementById('userId').value.trim();
            if (!/^\d+$/.test(userId)) return showResult('‚ö†Ô∏è User ID ph·∫£i l√† s·ªë!', 'error');
            if (!currentKey) return showResult('‚ö†Ô∏è Generate key tr∆∞·ªõc!', 'error');

            try {
                const data = await apiCall('/api/checkkey', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key: currentKey, user_id: userId })
                });
                showResult(data.valid ? `‚úÖ ${data.message}` : `‚ùå ${data.error || data.message}`, data.valid ? 'success' : 'error');
                if (data.valid) document.getElementById('checkBtn').disabled = true;
            } catch (err) {
                showResult('‚ùå ' + err.message, 'error');
            }
        }

        function copyKey() {
            navigator.clipboard.writeText(currentKey).then(() => showResult('üìã ƒê√£ copy key!', 'success'));
        }

        async function fetchKeys() {
            try {
                const data = await apiCall('/api/keys', { method: 'GET' });
                showResult(`üìä ${data.keys.length} keys\n${JSON.stringify(data.keys.slice(0, 3), null, 2)}`, 'success');
            } catch (err) {
                showResult('‚ùå L·ªói fetch keys', 'error');
            }
        }

        async function exportKeys() {
            try {
                const data = await apiCall('/api/keys', { method: 'GET' });
                const csv = 'Key,Users,Expires\n' + data.keys.map(k => `"${k.key}","${JSON.stringify(k.users)}","${k.expires_at}"`).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'keys.csv';
                a.click();
                showResult('üì• ƒê√£ export CSV!', 'success');
            } catch (err) {
                showResult('‚ùå L·ªói export', 'error');
            }
        }

        async function cleanup() {
            try {
                const data = await apiCall('/api/cleanup', { method: 'POST' });
                showResult(`üßπ Cleaned ${data.cleaned} expired keys`, 'success');
            } catch (err) {
                showResult('‚ùå Cleanup fail', 'error');
            }
        }

        document.getElementById('userId').addEventListener('keypress', (e) => e.key === 'Enter' && checkKey());
    </script>
</body>
</html>
